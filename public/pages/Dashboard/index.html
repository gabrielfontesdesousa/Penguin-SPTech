<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penguin Dahboard</title>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/Dashboard/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Penguin</title>
    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/Dashboard/cardCalendario.css">
    <link rel="stylesheet" href="../../css/Dashboard/graficoBarra.css">
    <link rel="stylesheet" href="../../css/Dashboard/cardRevisao.css">
    <link rel="stylesheet" href="../../css/Dashboard/cardSimulador.css">
    <link rel="stylesheet" href="../../css/Dashboard/graficoPizza.css">
    <link rel="stylesheet" href="../../css/Dashboard/header.css">
    <link rel="stylesheet" href="../../css/Dashboard/sidebarMenu.css">
    <link rel="stylesheet" href="../../css/Dashboard/cardKpis.css">
    <script src="https://cdn.j  sdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container-dashboard">
        <div class="sidebar-menu">
            <div class="itens-menu">
                <div class="item-menu telaAtual">
                    <a href=""> <img src="../../assets/layers 5.svg" alt=""></a>
                </div>
                <div class="item-menu">
                    <a href="../Expenses/"><img src="../../assets/layers 2.svg" alt=""></a>
                </div>
                <div class="item-menu">
                    <a href=""><img src="../../assets/In Transit.svg" alt=""></a>
                </div>
                <div class="item-menu">
                    <a href=""><img src="../../assets/layers 6.svg" alt=""></a>
                </div>
                <div class="item-menu">
                    <a href="../../index.html"><img src="../../assets/exit.svg" alt=""></a>
                </div>
            </div>
        </div>

        <div class="container-principal">
            <div class="sub-container-boas-vindas">
                <div class="text-boas-vindas">
                    <h1>Olá, <span id="nomeUser"></span></h1>
                </div>

            </div>

            <div class="layout-grid">
                <div class="coluna-esquerda">
                    <div class="container-kpis">
                        <div class="card-info" id="fretesRealizados"></div>
                        <div class="card-info" id="LucroLiquido"></div>
                        <div class="card-info" id="DistanciaTotal"></div>
                    </div>
                    <div class="card-grafico-barra">
                        <div class="header-grafico">
                            <h3>Faturamento do semestre</h3>
                            <span class="caixa-semestre">Semestre</span>
                        </div>
                        <div class="conteudo-grafico">
                            <canvas id="chart"></canvas>
                        </div>
                    </div>

                    <div class="container-graficos-bottom">
                        <div class="card-grafico-pizza">
                            <div class="conteudo-pizza">
                                <div class="grafico">
                                    <canvas id="donut"></canvas>
                                </div>

                                <div class="legenda">
                                    <h3>Despesas mensais<br>por tipo (em %)</h3>

                                    <div class="item"><span class="cor diesel"></span> Diesel</div>
                                    <div class="item"><span class="cor manut"></span> Outro</div>
                                    <div class="item"><span class="cor pedagio"></span> Pedágio</div>
                                    <div class="item"><span class="cor alim"></span> Alimentação</div>
                                </div>
                            </div>
                        </div>

                        <div class="card-revisao" id="Manutencao"></div>
                    </div>
                </div>

                <div class="coluna-direita">
                    <div class="card-calendario">
                        <div class="header-calendario">
                            <h3>Calendário Semanal</h3>
                        </div>
                        <div class="conteudo-calendario">
                            <p>Confira as coletas e entregas referentes a semana atual, <br>
                                para mais detalhes e gerenciamento, entre na tela de gerenciamento de fretes
                            </p>
                            <div>
                                <div id="listaAgenda" class="lista-fretes"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card-simulador">
                        <div class="header-simulador">
                            <h3>Fazer simulações de fretes</h3>
                        </div>
                        <p class="descricao-simulador">Faça simulações para ver a viabilidade de fretes e seus custos
                            envolvidos.</p>
                        <button class="btn-simular">Simular frete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../../js/dashboard.js"></script>
</body>

</html>

</html>
<script>
    nome = sessionStorage.getItem("NOME_DO_LOGADO")
    nomeUser.innerHTML = nome;
    function ConsultaKpiFretes() {
        var email = sessionStorage.getItem("EMAIL_DO_LOGADO")
        console.log('kpi fretes: ', email)
        if (email == null) {
            console.log("Nenhum email no sessionStorage");
        }
        fetch("/kpi/fretes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                email: email
            })
        })
            .then(function (resposta) {
                resposta.json()
                    .then(function (respostaConversao) {
                        fretesRealizados.innerHTML =
                            fretesRealizados.innerHTML = `
                                <div class="header-card">
                                    <div>
                                        <h3>Fretes</h3>
                                        <h3>Realizados</h3>
                                    </div>
                                    <span class="caixa-mes">Mês</span>
                                </div>
                                <div class="conteudo-card">
                                    <h2>${respostaConversao[0].TOTAL_FRETES_REALIZADOS}</h2>
                                    <span class="porcentagem positivo">↗ 17%</span>
                                </div>
                                <p class="descricao-card">Viagens realizadas na jornada do último mês</p>
`;
                    }).catch((erro) => {
                        console.log("ERRO:", erro)
                    })
            }).catch((erro) => {
                console.log(erro)
            })
            .then(function (fretes) {
                console.log("Resultado da KPI:", fretes);
                console.log("Quantidade de fretes realizados:", fretes);

            })
            .catch(erro => {
                console.log("ERRO:", erro);
            });
    }
    function ConsultaKpiLucroLiquido() {
        var email = sessionStorage.getItem("EMAIL_DO_LOGADO")
        console.log('kpi lucro:', email)
        fetch('/kpi/lucro', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                emailSessionServer: email
            })
        })
            .then(function (resposta) {
                resposta.json()
                    .then(function (respostaConversaoDados) {
                        console.log(respostaConversaoDados)
                        LucroLiquido.innerHTML = `
                        <div class="header-card">
                            <div>
                                <h3>Lucro Líquido</h3>
                                <h3>Mensal</h3>
                            </div>
                            <span class="porcentagem-mini positivo">↗ 5%</span>
                        </div>
                        <div class="conteudo-card">
                            <h2>R$ ${respostaConversaoDados}</h2>
                        </div>
                        <p class="descricao-card">Cálculo baseado na margem dos custos fixos e variáveis no mês anterior.</p>
`;
                    }).catch(function (errorConversao) {
                        console.log(errorConversao)
                    })
            }).catch(function (errorEnvio) {
                console.log(console.log(errorEnvio))
            })
    }
    function ConsultaKpiDistancia() {
        var email = sessionStorage.getItem("EMAIL_DO_LOGADO")
        var objManipularData = new Date();
        var ano = objManipularData.getFullYear();
        var mes = objManipularData.getMonth() + 1;
        fetch('/kpi/distancia', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body:
                JSON.stringify({
                    emailServer: email,
                    mesServer: mes,
                    anoServer: ano
                })
        })
            .then(function (resposta) {
                resposta.json()
                    .then(function (respostaConversao) {
                        DistanciaTotal.innerHTML = `
                        <div class="header-card">
                            <div>
                                <h3>Distância Total</h3>
                                <h3>Percorrida</h3>
                            </div>
                            <span class="caixa-mes">Mês</span>
                        </div>
                        <div class="conteudo-card">
                            <h2>${respostaConversao[0].TOTAL_DE_KM}</h2>
                            <span class="unidade">KM</span>
                            <span class="porcentagem positivo">↗ 12%</span>
                        </div>
                        <p class="descricao-card">Porcentagem relativa ao período anterior.</p>
                    `;
                    }).catch(function (erro) {
                        console.log(`ERRO CONVERSAO: ${erro}`)
                    })
            }).catch(function (erro) {
                console.log('ERRO AO BUSCAR DADOS NA ROTA: erro')
            })
    }
    function ConsultaKpiManutencao() {
        var email = sessionStorage.getItem("EMAIL_DO_LOGADO")
        fetch('/kpi/manutencao', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body:
                JSON.stringify({
                    emailServer: email,
                })
        })
            .then(function (resposta) {
                resposta.json()
                    .then(function (respostaConversao) {
                        Manutencao.innerHTML = `
                            <div class="header-revisao">
                                <h3>Sugestão de revisão em</h3>
                            </div>
                            <div class="conteudo-revisao">
                                <h2>${respostaConversao}</h2>
                                <span class="unidade-km">KMs</span>
                            </div>
                            <p class="descricao-revisao">Baseado no intervalo de KMs informado pelo usuário</p>
                            <p class="info-revisao">Gerenciamento baseado na quilometragem rodada de acordo com os fretes cadastrados na plataforma. Ajuste estimado baseado na sua distância, podendo variar.</p>
`;
                    }).catch(function (erro) {
                        console.log(`ERRO CONVERSAO: ${erro}`)
                    })
            }).catch(function (erro) {
                console.log(`ERRO AO BUSCAR DADOS NA ROTA: ${erro}`)
            })
    }
    function ConsultaGraficoSemestre() {
        var email = sessionStorage.getItem("EMAIL_DO_LOGADO")

        fetch('/grafico/semestre', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ emailServer: email })
        })
            .then(function (resposta) {
                resposta.json()
                    .then(function (respostaConversao) {
                        let labels = [];
                        let valores = [];

                        for (let i = 0; i < respostaConversao.length; i++) {
                            labels[i] = respostaConversao[i].mes;
                            valores[i] = respostaConversao[i].faturamento;
                        }

                        const ctx = document.getElementById('chart');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: "Faturamento",
                                    data: valores,
                                    borderWidth: 1,
                                    backgroundColor: [
                                        '#1BAFA9',
                                        '#FFFFFF',
                                        '#7B20E2'
                                    ],

                                }]
                            },
                            options: {
                                scales: { y: { beginAtZero: true } },
                                responsive: true,
                                maintainAspectRatio: false,
                                barPercentage: 0.40,
                            }
                        });
                    })
            })
            .catch(err => console.log(err))
    }
    function ConsultaGraficoDonnut() {
        var email = sessionStorage.getItem("EMAIL_DO_LOGADO")
        fetch('/grafico/donut', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body:
                JSON.stringify({
                    emailServer: email
                })
        })
            .then(function (resposta) {
                resposta.json()
                    .then(function (respostaConversao) {
                        let labels = [];
                        let valores = [];
                        for (let i = 0; i < respostaConversao.length; i++) {
                            labels[i] = respostaConversao[i].categoria, "%";
                            valores[i] = respostaConversao[i].total;
                        }
                        console.log(respostaConversao)
                        const ctx = document.getElementById('donut');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: valores,
                                    backgroundColor: [
                                        '#FFFFFF',
                                        '#636363',
                                        '#FFAE00',
                                        '#7B20E2',
                                        '#1BAFA9'
                                    ],
                                    borderWidth: 1,
                                }]
                            },
                            options: {
                                cutout: '60%',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                }
                            }
                        });
                    }).catch(function (errorConversao) {
                        console.log(errorConversao)
                    })
            }).catch(function (erro) {
                console.log(erro)
            })

    }
    function ConsultaAgenda() {
        var email = sessionStorage.getItem("EMAIL_DO_LOGADO")
        fetch('/usuarios/agenda', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                emailServer: email
            })
        })
            .then(function (resposta) {
                resposta.json()
                    .then(function (respostaConversao) {
                        console.log(respostaConversao)
                        for (let i = 0; i < respostaConversao.length; i++) {
                            listaAgenda.innerHTML += `
                                <div class="item-agenda">
                                    <strong>${respostaConversao[i].DATA_SAIDA}</strong> - ${respostaConversao[i].NOME_CLIENTE} - ${respostaConversao[i].BAIRRO}, ${respostaConversao[i].ESTADO}
                                </div>
                              `;
                        }
                    }).catch(function (errorConversao) {
                        console.log(errorConversao)
                    })
            }).catch(function (erroResposta) {
                console.log(erroResposta)
            })

    }

    window.onload = function () {
        ConsultaKpiFretes()
        ConsultaKpiLucroLiquido()
        ConsultaKpiDistancia()
        ConsultaKpiManutencao()
        ConsultaGraficoSemestre()
        ConsultaGraficoDonnut()
        ConsultaAgenda()
    }

</script>
